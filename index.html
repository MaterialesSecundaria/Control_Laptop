<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Laptops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 50px;
        }
        
        .navbar {
            background-color: var(--secondary-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border: none;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .table th {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-delivered {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .section-title {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .action-buttons .btn {
            margin-right: 5px;
        }
        
        .reception-info {
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .connection-status {
            position: fixed;
            bottom: 70px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .disconnected {
            background-color: var(--accent-color);
            color: white;
        }
        
        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 15px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand logo" href="#">
                <i class="fas fa-laptop-code me-2"></i>Gestión de Laptops
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-question-circle me-1"></i> Ayuda</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Instrucciones -->
        <div class="instructions mb-4">
            <h5><i class="fas fa-info-circle me-2"></i>Instrucciones de uso</h5>
            <p class="mb-0">Complete el formulario para registrar una entrega. Los datos se guardarán en Google Sheets. Asegúrese de configurar correctamente el Google Apps Script.</p>
        </div>

        <!-- Formulario de Registro -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-pencil-alt me-2"></i>Registrar Entrega
            </div>
            <div class="card-body">
                <form id="deliveryForm">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="laptopNumber" class="form-label">Laptop</label>
                            <select class="form-select" id="laptopNumber" required>
                                <option value="" selected disabled>-- Seleccionar --</option>
                                <option value="LAP-01">LAP-01</option>
                                <option value="LAP-02">LAP-02</option>
                                <option value="LAP-03">LAP-03</option>
                                <option value="LAP-04">LAP-04</option>
                                <option value="LAP-05">LAP-05</option>
                                <option value="LAP-06">LAP-06</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="deliveryDate" class="form-label">Fecha de entrega</label>
                            <input type="date" class="form-control" id="deliveryDate" required>
                        </div>
                        <div class="col-md-4">
                            <label for="deliveredTo" class="form-label">Persona a quien se entrega</label>
                            <div class="input-group">
                                <select class="form-select" id="deliveredTo" required>
                                    <option value="" selected disabled>-- Seleccionar --</option>
                                    <option value="Mauricio Roman">Mauricio Roman</option>
                                    <option value="Ana García">Ana García</option>
                                    <option value="Carlos López">Carlos López</option>
                                    <option value="María Fernández">María Fernández</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="addPersonBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Accesorios entregados</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="mouseCheck" value="Mouse">
                                <label class="form-check-label" for="mouseCheck">Mouse</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="caseCheck" value="Estuche">
                                <label class="form-check-label" for="caseCheck">Estuche</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="chargerCheck" value="Cargador">
                                <label class="form-check-label" for="chargerCheck">Cargador</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary me-2" id="submitBtn">
                                <i class="fas fa-save me-1"></i>Registrar entrega
                            </button>
                            <button type="button" class="btn btn-success me-2" id="exportCSV">
                                <i class="fas fa-file-csv me-1"></i>Exportar CSV
                            </button>
                            <button type="button" class="btn btn-danger" id="clearRecords">
                                <i class="fas fa-trash me-1"></i>Limpiar registros
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de Registros -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table me-2"></i>Registros
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="filterDate" class="form-label">Filtrar por fecha:</label>
                        <input type="date" class="form-control" id="filterDate">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-secondary" id="clearFilter">
                            <i class="fas fa-times me-1"></i>Limpiar filtro
                        </button>
                    </div>
                    <div class="col-md-6 text-end d-flex align-items-end justify-content-end">
                        <button type="button" class="btn btn-outline-primary" id="refreshData">
                            <i class="fas fa-sync-alt me-1"></i>Actualizar datos
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="recordsTable">
                        <thead>
                            <tr>
                                <th>Laptop</th>
                                <th>Fecha entrega</th>
                                <th>Entregado a</th>
                                <th>Accesorios</th>
                                <th>Recepción</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <!-- Los registros se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reporte PDF -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-file-pdf me-2"></i>Reporte por fecha
            </div>
            <div class="card-body">
                <p>Seleccione una fecha para generar un reporte PDF solo de los dispositivos recepcionados.</p>
                <div class="row">
                    <div class="col-md-4">
                        <label for="reportDate" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="reportDate">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary" id="generatePDF">
                            <i class="fas fa-file-pdf me-1"></i>Generar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar persona -->
    <div class="modal fade" id="addPersonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar nueva persona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newPersonName" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="newPersonName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewPerson">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para recepción -->
    <div class="modal fade" id="receptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receptionModalTitle">Registrar Recepción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="receptionLaptopId">
                    <div class="mb-3">
                        <label for="receptionDate" class="form-label">Fecha de recepción</label>
                        <input type="date" class="form-control" id="receptionDate">
                    </div>
                    <div class="mb-3">
                        <label for="receivedBy" class="form-label">Recibido por</label>
                        <input type="text" class="form-control" id="receivedBy">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="completeCheck">
                            <label class="form-check-label" for="completeCheck">
                                Todos los accesorios completos
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveReception">Guardar recepción</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de conexión -->
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-wifi"></i> Sin conexión a Google Sheets
    </div>

    <footer>
        <div class="container">
            <p class="mb-0">Sistema de Gestión de Laptops &copy; 2025</p>
        </div>
    </footer>

    <script>
        // Configuración para Google Sheets
        // REEMPLACE ESTA URL CON LA URL DE SU GOOGLE APPS SCRIPT
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyTqbWjl19GI0Ncf9mGVD6dXJmg3wRE7PPAVmAK5lrg2hEVVIYCLRT38ScUoaMSkryC/exec';
        
        // Almacenamiento local para los registros (solo como respaldo)
        let records = [];
        let peopleList = ['Mauricio Roman', 'Ana García', 'Carlos López', 'María Fernández'];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer fecha actual por defecto
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            document.getElementById('deliveryDate').value = formattedDate;
            
            // Cargar lista de personas
            loadPeopleList();
            
            // Cargar registros desde Google Sheets
            loadRecordsFromSheets();
            
            // Event listeners
            document.getElementById('addPersonBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addPersonModal'));
                modal.show();
            });
            
            document.getElementById('saveNewPerson').addEventListener('click', function() {
                const newPersonName = document.getElementById('newPersonName').value.trim();
                if (newPersonName) {
                    // Agregar a la lista si no existe
                    if (!peopleList.includes(newPersonName)) {
                        peopleList.push(newPersonName);
                        
                        // Actualizar dropdown
                        loadPeopleList();
                    }
                    
                    // Seleccionar la nueva persona
                    document.getElementById('deliveredTo').value = newPersonName;
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addPersonModal'));
                    modal.hide();
                    
                    document.getElementById('newPersonName').value = '';
                }
            });
            
            document.getElementById('deliveryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Mostrar indicador de carga
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
                submitBtn.disabled = true;
                
                // Obtener valores del formulario
                const laptop = document.getElementById('laptopNumber').value;
                const date = document.getElementById('deliveryDate').value;
                const person = document.getElementById('deliveredTo').value;
                
                // Obtener accesorios seleccionados
                const accessories = [];
                if (document.getElementById('mouseCheck').checked) accessories.push('Mouse');
                if (document.getElementById('caseCheck').checked) accessories.push('Estuche');
                if (document.getElementById('chargerCheck').checked) accessories.push('Cargador');
                
                // Crear nuevo registro
                const newRecord = {
                    id: Date.now(), // ID único
                    laptop: laptop,
                    date: date,
                    person: person,
                    accessories: accessories.join(', '),
                    receptionDate: '',
                    receivedBy: '',
                    complete: 'No',
                    status: 'Pendiente'
                };
                
                // Enviar datos a Google Sheets
                sendDataToSheets(newRecord)
                    .then(() => {
                        alert('Entrega registrada exitosamente en Google Sheets');
                        
                        // Recargar la tabla
                        loadRecordsFromSheets();
                        
                        // Resetear formulario
                        this.reset();
                        document.getElementById('deliveryDate').value = formattedDate;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al guardar en Google Sheets. Los datos se guardarán localmente.');
                        
                        // Guardar en localStorage como respaldo
                        records.push(newRecord);
                        localStorage.setItem('laptopRecords', JSON.stringify(records));
                        loadRecords();
                    })
                    .finally(() => {
                        // Restaurar botón
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            });
            
            document.getElementById('exportCSV').addEventListener('click', function() {
                exportToCSV();
            });
            
            document.getElementById('clearRecords').addEventListener('click', function() {
                if (confirm('¿Está seguro de que desea eliminar todos los registros? Esta acción no se puede deshacer.')) {
                    // Aquí debería implementar la lógica para borrar registros en Google Sheets
                    alert('Función de limpieza completa requiere implementación adicional en Google Apps Script');
                }
            });
            
            document.getElementById('generatePDF').addEventListener('click', function() {
                const reportDate = document.getElementById('reportDate').value;
                if (!reportDate) {
                    alert('Por favor seleccione una fecha para generar el reporte');
                    return;
                }
                
                generatePDF(reportDate);
            });
            
            document.getElementById('filterDate').addEventListener('change', function() {
                filterRecordsByDate(this.value);
            });
            
            document.getElementById('clearFilter').addEventListener('click', function() {
                document.getElementById('filterDate').value = '';
                loadRecords();
            });
            
            document.getElementById('refreshData').addEventListener('click', function() {
                const refreshBtn = document.getElementById('refreshData');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Actualizando...';
                refreshBtn.disabled = true;
                
                loadRecordsFromSheets()
                    .finally(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    });
            });
            
            // Delegación de eventos para los botones de la tabla
            document.getElementById('recordsBody').addEventListener('click', function(e) {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                
                const recordId = row.getAttribute('data-id');
                
                if (target.classList.contains('btn-receive')) {
                    document.getElementById('receptionLaptopId').value = recordId;
                    document.getElementById('receptionDate').value = new Date().toISOString().substr(0, 10);
                    
                    const modal = new bootstrap.Modal(document.getElementById('receptionModal'));
                    modal.show();
                }
                else if (target.classList.contains('btn-edit')) {
                    editRecord(recordId);
                }
                else if (target.classList.contains('btn-delete')) {
                    deleteRecord(recordId);
                }
            });
            
            document.getElementById('saveReception').addEventListener('click', function() {
                const recordId = document.getElementById('receptionLaptopId').value;
                const receptionDate = document.getElementById('receptionDate').value;
                const receivedBy = document.getElementById('receivedBy').value;
                const complete = document.getElementById('completeCheck').checked ? 'Sí' : 'No';
                
                if (!receptionDate || !receivedBy) {
                    alert('Por favor complete todos los campos');
                    return;
                }
                
                // Encontrar el registro
                const recordIndex = records.findIndex(record => record.id == recordId);
                if (recordIndex !== -1) {
                    const updatedRecord = {
                        ...records[recordIndex],
                        receptionDate: receptionDate,
                        receivedBy: receivedBy,
                        complete: complete,
                        status: 'Recepcionado'
                    };
                    
                    // Actualizar en Google Sheets
                    updateRecordInSheets(updatedRecord)
                        .then(() => {
                            // Actualizar localmente
                            records[recordIndex] = updatedRecord;
                            
                            // Recargar tabla
                            loadRecords();
                            
                            // Cerrar modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('receptionModal'));
                            modal.hide();
                            
                            alert('Recepción registrada exitosamente');
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error al actualizar en Google Sheets. Los cambios se guardarán localmente.');
                            
                            // Actualizar localmente como respaldo
                            records[recordIndex] = updatedRecord;
                            localStorage.setItem('laptopRecords', JSON.stringify(records));
                            loadRecords();
                            
                            const modal = bootstrap.Modal.getInstance(document.getElementById('receptionModal'));
                            modal.hide();
                        });
                }
            });
        });
        
        // Función para enviar datos a Google Sheets
        async function sendDataToSheets(record) {
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'create',
                        ...record
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                const result = await response.json();
                
                if (result.result === 'success') {
                    updateConnectionStatus(true);
                    return result;
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                updateConnectionStatus(false);
                throw error;
            }
        }
        
        // Función para cargar registros desde Google Sheets
        async function loadRecordsFromSheets() {
            try {
                const response = await fetch(scriptURL + '?action=read');
                
                if (!response.ok) {
                    throw new Error('Error al cargar datos desde Google Sheets');
                }
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    records = data.records || [];
                    updateConnectionStatus(true);
                    loadRecords();
                } else {
                    throw new Error(data.error || 'Error al cargar datos');
                }
            } catch (error) {
                console.error('Error:', error);
                updateConnectionStatus(false);
                
                // Cargar desde localStorage como respaldo
                const localData = localStorage.getItem('laptopRecords');
                if (localData) {
                    records = JSON.parse(localData);
                    loadRecords();
                    alert('Usando datos locales. No se pudo conectar con Google Sheets.');
                }
            }
        }
        
        // Función para actualizar un registro en Google Sheets
        async function updateRecordInSheets(record) {
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        ...record
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                const result = await response.json();
                
                if (result.result === 'success') {
                    updateConnectionStatus(true);
                    return result;
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                updateConnectionStatus(false);
                throw error;
            }
        }
        
        // Función para actualizar el estado de conexión
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> Conectado a Google Sheets';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> Sin conexión a Google Sheets';
            }
        }
        
        function loadPeopleList() {
            const select = document.getElementById('deliveredTo');
            // Guardar valor seleccionado
            const selectedValue = select.value;
            
            // Limpiar opciones excepto la primera
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Agregar personas
            peopleList.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
            
            // Restaurar valor seleccionado si existe
            if (selectedValue && peopleList.includes(selectedValue)) {
                select.value = selectedValue;
            }
        }
        
        function loadRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            if (records.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" class="text-center">No hay registros disponibles</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            // Ordenar registros por fecha (más reciente primero)
            const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedRecords.forEach(record => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', record.id);
                
                // Formatear fecha para mostrar
                const deliveryDate = formatDateForDisplay(record.date);
                
                tr.innerHTML = `
                    <td>${record.laptop}</td>
                    <td>${deliveryDate}</td>
                    <td>${record.person}</td>
                    <td>${record.accessories || 'Ninguno'}</td>
                    <td class="reception-info">
                        ${record.status === 'Recepcionado' ? 
                            `<div>Fecha: ${formatDateForDisplay(record.receptionDate)}</div>
                             <div>Por: ${record.receivedBy}</div>
                             <div>Completo: ${record.complete}</div>` : 
                            'Pendiente de recepción'}
                    </td>
                    <td><span class="status-badge ${record.status === 'Recepcionado' ? 'badge-delivered' : 'badge-pending'}">${record.status}</span></td>
                    <td class="action-buttons">
                        ${record.status === 'Pendiente' ? 
                            `<button class="btn btn-sm btn-success btn-receive" title="Registrar recepción">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                        <button class="btn btn-sm btn-warning btn-edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function filterRecordsByDate(date) {
            if (!date) {
                loadRecords();
                return;
            }
            
            const filteredRecords = records.filter(record => record.date === date);
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" class="text-center">No hay registros para la fecha seleccionada</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            filteredRecords.forEach(record => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', record.id);
                
                // Formatear fecha para mostrar
                const deliveryDate = formatDateForDisplay(record.date);
                
                tr.innerHTML = `
                    <td>${record.laptop}</td>
                    <td>${deliveryDate}</td>
                    <td>${record.person}</td>
                    <td>${record.accessories || 'Ninguno'}</td>
                    <td class="reception-info">
                        ${record.status === 'Recepcionado' ? 
                            `<div>Fecha: ${formatDateForDisplay(record.receptionDate)}</div>
                             <div>Por: ${record.receivedBy}</div>
                             <div>Completo: ${record.complete}</div>` : 
                            'Pendiente de recepción'}
                    </td>
                    <td><span class="status-badge ${record.status === 'Recepcionado' ? 'badge-delivered' : 'badge-pending'}">${record.status}</span></td>
                    <td class="action-buttons">
                        ${record.status === 'Pendiente' ? 
                            `<button class="btn btn-sm btn-success btn-receive" title="Registrar recepción">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                        <button class="btn btn-sm btn-warning btn-edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function editRecord(id) {
            const record = records.find(record => record.id == id);
            if (record) {
                // Llenar formulario con los datos del registro
                document.getElementById('laptopNumber').value = record.laptop;
                document.getElementById('deliveryDate').value = record.date;
                document.getElementById('deliveredTo').value = record.person;
                
                // Marcar accesorios
                const accessories = record.accessories.split(', ');
                document.getElementById('mouseCheck').checked = accessories.includes('Mouse');
                document.getElementById('caseCheck').checked = accessories.includes('Estuche');
                document.getElementById('chargerCheck').checked = accessories.includes('Cargador');
                
                // Eliminar registro antiguo
                deleteRecord(id, false);
                
                alert('Puede editar los datos del registro en el formulario.');
            }
        }
        
        function deleteRecord(id, showAlert = true) {
            if (confirm('¿Está seguro de que desea eliminar este registro?')) {
                // Encontrar el índice del registro
                const recordIndex = records.findIndex(record => record.id == id);
                
                if (recordIndex !== -1) {
                    const recordToDelete = records[recordIndex];
                    
                    // Eliminar de Google Sheets
                    deleteRecordFromSheets(recordToDelete)
                        .then(() => {
                            // Eliminar localmente
                            records.splice(recordIndex, 1);
                            loadRecords();
                            
                            if (showAlert) {
                                alert('Registro eliminado exitosamente');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error al eliminar de Google Sheets. El registro se eliminará localmente.');
                            
                            // Eliminar localmente como respaldo
                            records.splice(recordIndex, 1);
                            localStorage.setItem('laptopRecords', JSON.stringify(records));
                            loadRecords();
                            
                            if (showAlert) {
                                alert('Registro eliminado localmente');
                            }
                        });
                }
            }
        }
        
        // Función para eliminar registro de Google Sheets
        async function deleteRecordFromSheets(record) {
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: record.id
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                const result = await response.json();
                
                if (result.result === 'success') {
                    updateConnectionStatus(true);
                    return result;
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                updateConnectionStatus(false);
                throw error;
            }
        }
        
        function exportToCSV() {
            if (records.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            
            // Encabezados CSV
            let csv = 'Laptop,Fecha entrega,Entregado a,Accesorios,Recepción (Fecha),Recepción (Por),Completo,Estado\n';
            
            // Datos
            records.forEach(record => {
                csv += `"${record.laptop}","${record.date}","${record.person}","${record.accessories}","${record.receptionDate}","${record.receivedBy}","${record.complete}","${record.status}"\n`;
            });
            
            // Crear blob y descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'registro_laptops.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function generatePDF(date) {
            // Filtrar registros recepcionados para la fecha seleccionada
            const filteredRecords = records.filter(record => 
                record.status === 'Recepcionado' && record.receptionDate === date
            );
            
            if (filteredRecords.length === 0) {
                alert('No hay registros recepcionados para la fecha seleccionada');
                return;
            }
            
            // Usar jsPDF para generar el PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text('Reporte de Recepción de Laptops', 14, 22);
            doc.setFontSize(12);
            doc.text(`Fecha: ${formatDateForDisplay(date)}`, 14, 30);
            
            // Preparar datos para la tabla
            const tableData = filteredRecords.map(record => [
                record.laptop,
                record.person,
                record.accessories,
                record.receivedBy,
                record.complete
            ]);
            
            // Generar tabla
            doc.autoTable({
                startY: 40,
                head: [['Laptop', 'Entregado a', 'Accesorios', 'Recibido por', 'Completo']],
                body: tableData,
                theme: 'grid',
                headStyles: {
                    fillColor: [44, 62, 80]
                }
            });
            
            // Guardar PDF
            doc.save(`reporte_laptops_${date}.pdf`);
        }
        
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }
    </script>
</body>
</html>